@echo off
setlocal

REM ASCII Art
echo @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%#*+===---==+**#%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%*=-:...:..........:-=*%%@@@@@@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@@@@@@%%*-:::---:--==::::.....:--=*%%@@@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@@@%%===------:-=++*+=-:.....:-=--+%%@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@@#=#*==+===--=++*#***+---::..:=+=-#@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@%*%****#*++*####+#%%%*+##=:::...:*+:#@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@%#%*++*#*#++*%%%%%%++%%%#=:::....:*==@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@#%%#*##***+**+**#%%++%%##+---::::.-*-%@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@#%%#*+=#%#-+*#*+++*%%%*++**+=---:.*-%@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@%%#+##**%%#**%%@**%%###%%%**++*=-:++#@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@%%###%#=*%%%%%%#*%%%%%%##%#####=::+*#@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@%%%%#%%%###%%%#*%%%%%%*+**%%#%%*.-**#@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%###%%#*%%%%%%%%#%%@#*%%*:-#*#@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@@*#%%%%%*#%%%##%%%%%%%%%%%#**#*=-=%*%@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@@%%==*%%%#%%%%#%%#%%%%%%%%##*+++=-+%%#%@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@@@@@@%*+%%%%%%%%%%%%%%%%%%%%%%##**+#%%%#@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@@%%#***+++#%%%%%%%%%%%%#%#%%%%%%%%%%%%##%%%%@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@@@+::.:=-::=#%%%%%%%%%#%%%%%%%%%%%%%%%%%#%%%@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@%-::-=+#*-+*#%%%%%%%%%%%%%%%%%%%%%%%%#%%%%%@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@%+*===-++++**##%%%%%%%%%%%%%%%%%%%#%%%%%%%@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@%%%%%%##***++++**#%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@%+#%%%%%%@@@@@@%%###%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@@@*#%%#*+=====+*#%%%%%%%%%%%%%%%@#**#%%%@@%%%%@@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@@@%%#*=:::-=++-:::-=+#%%%%%%%%@@#%%%*+*#%%@@@@@@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@@@%%+-:.......::=**+=--=+*#%%%%%%%%#%%#*=---=+#%%@@@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@@@#-.........:::::=*###***#%%%%%%%#%%%##*==*=:..:+%@@@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@@%=:.:::-::::::::::::-+**###%%%%%%%%%%%##*=+*+--:.-*%%@@@@@@@@@@@@@@@@@@@
echo @@@@@@@@*-:..:::-=::--:::-::::--=+#*#%%%%%%#%%%#%#++*+=-*:::-*%%@@@@@@@@@@@@@@@@@
echo @@@@@@@*---:.:::-+---=-::--::::-==+#+*#%%%%%%##*%#*=*+=-**-+::=%%@@@@@@@@@@@@@@@@
echo @@@@@@%#+=##=:::-*---==-::-:::::---+*=+*##%%%####%%%#=+===*-+=--+@@@@@@@@@@@@@@@@
echo @@@@@%%#+=+%%*=-=*=-====:::-::::---=++==+**#%%#*###*====-**=*=+*%%@@@@@@@@@@@@@@@
echo @@@@@%%*++=#%%#++#+--=++-::---------=++===++*##*###*+-==-=#+*+*#*@@@@@@@@@@@@@@@
echo @@@@@%#+**=*%%%###*-==+++---=-=++=-==++===++*##*##**+=-=--##*#%%*%%@@@@@@@@@@@@@@
echo @@@@%%**##++#%%%#%%#===+##%%#*++==+=--==++==+***#******+--=-+%%%#%%%*#@@@@@@@@@@@@@@
echo @@@@%%*#%#++#%%%%%%+==*%%%%#+=========+*+=+******##**+=--==##%%%#%%@@@@@@@@@@@@@@@
echo @@@@%#*%%#*=*%%%%%%+=+#%%###*+=======++**+=+******###**=:==*%%%%###@@@@@@@@@@@@@
echo @@@@%*#%%%#++#%%%%%*+#%%#####*+===++++++**=+******####**--=*%%%%##*%%@@@@@@@@@@@@
echo @@@##%%%%%%*+#%%%%%%#*#####%###*******++**#*=+*#***#####*+=+*%%%%##*#@@@@@@@@@@@@
echo @@%##%%%%%%#**%%%%%%#***#%%%###*****#***###++*##**######****%%#####*%%@@@@@@@@@@@
echo @@%%%%%%%%%%#*#%%%%%%#***%%%%############%%#*+**#**#######**##%%#***##%%@@@@@@@@@@@
echo @@%%%%%%%%%%%*#%%%%%%##*#%%%%%%%#%##%%%%%%%##*****####%%%#*####***####@@@@@@@@@@@
echo @%%%%%%%%%%%%##%%%%%%**%%%%%%%%%%%%%%%%%%%%%%#*****#####%%%#####*###%%##%%@@@@@@@@@@@
echo @%%%%%%%%%%%%%##%%%%%%%%%%%%##%%%%%%%%%%%%%%##****####%%%%##%#%%%%%%%##%@@@@@@@@@@@

REM Function to create directory if it does not exist
:CREATE_DIR_IF_NOT_EXISTS
IF NOT EXIST "%1" (
    mkdir "%1"
)
exit /b

REM Default values
set "VENV_DIR=venv"
set "ROOT_DIR=%USERPROFILE%\deforum"
set "COMFY_DIR=src\ComfyUI"
set "SILENT=0"

REM Parse arguments
:PARSE_ARGUMENTS
for %%A in (%*) do (
    if "%%A"=="-s" (
        set "SILENT=1"
    ) else (
        echo Invalid option: %%A
        exit /b 1
    )
)

REM Collect VENV_PATH
if "%SILENT%"=="0" (
    set /p "VENV_INPUT=Enter virtual environment path (default: %VENV_DIR%): "
    if not "%VENV_INPUT%"=="" (
        set "VENV_DIR=%VENV_INPUT%"
    )
)
call :CREATE_DIR_IF_NOT_EXISTS "%VENV_DIR%"
for /f "delims=" %%i in ('powershell -Command "[System.IO.Path]::GetFullPath('%VENV_DIR%')"') do set "VENV_PATH=%%i"

REM Collect ROOT_PATH
if "%SILENT%"=="0" (
    set /p "ROOT_INPUT=Enter root directory path (default: %ROOT_DIR%): "
    if not "%ROOT_INPUT%"=="" (
        set "ROOT_DIR=%ROOT_INPUT%"
    )
)
call :CREATE_DIR_IF_NOT_EXISTS "%ROOT_DIR%"
for /f "delims=" %%i in ('powershell -Command "[System.IO.Path]::GetFullPath('%ROOT_DIR%')"') do set "ROOT_PATH=%%i"

REM Collect COMFY_PATH
if "%SILENT%"=="0" (
    set /p "COMFY_INPUT=Enter ComfyUI directory path (default: %COMFY_DIR%): "
    if not "%COMFY_INPUT%"=="" (
        set "COMFY_DIR=%COMFY_INPUT%"
    )
)
call :CREATE_DIR_IF_NOT_EXISTS "%COMFY_DIR%"
for /f "delims=" %%i in ('powershell -Command "[System.IO.Path]::GetFullPath('%COMFY_DIR%')"') do set "COMFY_PATH=%%i"

REM Save to .env file
echo VENV_PATH=%VENV_PATH% > .env
echo ROOT_PATH=%ROOT_PATH% >> .env
echo COMFY_PATH=%COMFY_PATH% >> .env

REM Create virtual environment and install dependencies
python -m venv "%VENV_PATH%"
call "%VENV_PATH%\Scripts\activate.bat"
pip install -e .

echo Installation completed successfully.
